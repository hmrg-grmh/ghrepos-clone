# åœ¨ SHell ä¸Šåšå‘½ä»¤æ‰§è¡Œå¤±è´¥åŽé‡è¯•

## demo

1. åªæ˜¯è¦æç¤ºçš„è¯
   
   ~~~~ sh
   curl xxxx && echo :ok xxx || echo :err xxx
   ~~~~
   
   ï¼ˆä¸Šé¢çš„å†’å· `:` æ²¡æœ‰ç‰¹åˆ«ä½œç”¨åªæ˜¯å­—ç¬¦ä¸²è€Œå·²ï¼‰
   
   å¦‚æžœæƒ³è¿™ä¸ªæç¤ºè¿›å…¥æ ‡å‡†é”™è¯¯ï¼Œå¯¹åº”ç‰‡æ®µåƒè¿™æ ·å°±è¡Œï¼š
   
   ~~~ sh
   echo xxx >&2
   ~~~
   
2. å¦‚æžœæƒ³è¦å®ƒè‡ªåŠ¨é‡åšçš„è¯ï¼ˆç”±äºŽè¦ç”¨ `declare` æ‰€ä»¥ `sh` å°±ä¸è¡Œäº†è¿™é‡Œæ˜¯ `bash` ä»£ç ï¼‰
   
   ~~~~ bash
   # def your work
   works ()
   {
       sleep 1 ; cd xxx ;
   } ;
   
   # redo if fail
   retry ()
   {
       works_def_name="$1" tried="${2:-0}" &&
       
       "$works_def_name" &&
       { echo :ok "$works_def_name" ... "$tried" ; } ||
       { echo :err "$works_def_name" ... "$tried" ;
         exec bash -c "$(declare -f "$works_def_name") ; $(declare -f retry) ; retry '$works_def_name' $((tried+1))" ; } ;
   } ;
   ~~~~
   
   ä½¿ç”¨ï¼š
   
   ~~~ bash
   (retry works)
   ~~~
   
   ä¸Šé¢çš„ä»£ç ä¼šä¸åœåœ°åœ¨ç­‰å¾…åŽå°è¯• `cd xxx` è¿™ä¸ªå‘½ä»¤ï¼Œå¦‚æžœæ²¡è¿™ä¸ªç›®å½•å°±ä¼šå¤±è´¥ï¼Œè¾“å‡ºçš„ä¿¡æ¯é‡Œä¼šå¸¦æœ‰å·²ç»å°è¯•äº†å‡ æ¬¡çš„è®¡æ•°ã€‚
   
   ä¹Ÿå¯ä»¥ç”¨è¿™æ ·ä¸€ä¸ªæ›´ç®€å•çš„ä¾‹å­ç†è§£ï¼š
   
   ~~~~ bash
   cd_retring ()
   {
       n="${1:-0}" &&
       cd "$n" &&
       { echo :succ cd ... "${1:-0}" ; } ||
       { echo :fail cd ... "${1:-0}" ; exec bash -c "$(declare -f cd_retring) ; cd_retring '$((n+1))'" ; } ;
   } ;
   ~~~~
   
   ä½¿ç”¨ï¼š
   
   ~~~ bash
   (cd_retring) #or (cd_retring 114514) will let num begin with 114514
   ~~~
   
   åŽŸç†å°±æ˜¯æŠŠå®šä¹‰äº¤ç»™ `exec bash -c` ä»Žè€Œåœ¨å­è¿›ç¨‹é‡Œä¹Ÿä¿æŒå®šä¹‰ã€‚è¿™ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥ç”¨äºŽè¿œç¨‹æ‰§è¡Œæœ¬åœ°å®šä¹‰çš„å‡½æ•°ã€‚
   
3. å¦‚æžœä¸æ˜¯ç”¨å‡½æ•°è€Œæ˜¯æŠŠ `works` é‡Œçš„ä»£ç å†™è¿›è„šæœ¬æ–‡ä»¶ï¼Œå¯¹åº”çš„ `retry` é‡Œå°±ä¸éœ€å†™ `exec bash -c "$(declare -f works)"` äº†ï¼Œåªéœ€è¦ `exec bash works.sh` å°±å¥½ï¼Œè€Œä¸”ç”±äºŽä¸ç”¨ `declare` äº†æ‰€ä»¥åº”è¯¥ä¹Ÿèƒ½ç”¨ `sh` äº†ï¼Œä½†è¿™å°±å¯¼è‡´è¦å¯¹æ–‡ä»¶ç³»ç»Ÿå†…çš„å†…å®¹äº§ç”Ÿå½±å“ã€‚
   
   å…³äºŽ `exec` ï¼š
   
   å¦‚æžœä¸æ˜¯ `exec bash` è€Œæ˜¯ `bash` çš„è¯ï¼Œå°±å¯èƒ½ä¼šè®©å‡½æ•°è°ƒç”¨çš„ç±»ä¼¼äºŽã€åŽ‹æ ˆã€‘çš„æ“ä½œåªå¢žä¸å‡ï¼Œä»Žè€Œåœ¨æŸä¸ªæ—¶å€™æº¢å‡ºï¼ŒçŽ°è±¡å°±æ˜¯å¡æ­»ç„¶åŽæŠ¥ä¸ªé”™ï¼Œç„¶åŽç»“æŸã€‚ä¸è¿‡ï¼Œæ¯”è¾ƒæ–°ç‰ˆæœ¬çš„ `bash` ä¸ä¼šå¡æ­»æˆ–è€…ç»“æŸï¼Œè€Œæ˜¯åœ¨ã€åŽ‹æ ˆã€‘å¤Ÿå¤šåŽç»™ä¸ªè­¦å‘Šã€‚
   
   è€Œ `exec` çš„ä½œç”¨å°±æ˜¯ï¼Œå“ªæ€• `exec bash` è¿™å¥åŽé¢è¿˜æœ‰è¯­å¥ï¼Œä¹Ÿä¼šè¢«å¿½ç•¥æŽ‰ï¼Œä¹Ÿå°±æ˜¯å¼ºè¡Œä¸¢å¼ƒå¤–ä¸€å±‚çš„å‡½æ•°ä¸­çš„ä¸€åˆ‡ï¼Œç”¨æ–°å¯åŠ¨çš„è¿›ç¨‹æŠŠå¤–å±‚åŽŸæœ¬è¦åšçš„äº‹å…¨è¦†ç›–æŽ‰ã€‚
   

è¿™ä¸ªçŽ©æ³•æ˜¯æˆ‘è‡ªå·±å› ä¸ºä¸æƒ³å†™å¾ªçŽ¯çš„åµŒå¥—ç„¶åŽè¯•å‡ºæ¥çš„ã€‚åŽæ¥åˆäº†è§£äº† lambda æ¼”ç®—è¿˜æœ‰ Y ç»„åˆå­ä»€ä¹ˆçš„ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰è”ç³»â€¦â€¦è¿™é‡Œé¢ç›¸å½“äºŽæœ‰é€’å½’äº†ï¼Œå‡½æ•°åœ¨é”™è¯¯æ—¶ç”¨æ–°çš„å‚æ•°ï¼ˆæ–°çš„è®¡æ•°ï¼‰è°ƒç”¨äº†è‡ªèº«ã€‚è€Œ `exec` ç›¸å½“äºŽåœ¨ `sh` ä¸Šå¼ºåˆ¶é€ æˆä¸€ç§å‡½æ•°å¼çš„å°¾é€’å½’çš„æ•ˆæžœã€‚

## code

ä¸Šé¢çš„ä»£ç éƒ½åŠ äº†å¿…è¦çš„ `;` è¿˜æœ‰åˆ«çš„å„ç§ç¬¦å·ã€‚

æˆ‘å½’çº³äº†ä¸€äº›ç¬¦å·ï¼Œç®¡å®ƒä»¬å«å‘½ä»¤çš„ *ç»“å°¾ç¬¦* ï¼š

- `;` ï¼šè¡¨ç¤º *å¦‚æžœä¸Šä¸€æ¡æ‰§è¡Œå®Œå°±æ‰§è¡Œä¸‹ä¸€æ¡*
- `&` ï¼šè¡¨ç¤º *ä¸Šä¸€æ¡ä½œä¸ºåŽå°è¿›ç¨‹æ‰§è¡Œï¼ˆå®ƒä»ç„¶æ˜¯å½“å‰ SHell è¿›ç¨‹çš„å­è¿›ç¨‹ï¼‰*
- `&&` ï¼šè¡¨ç¤º *å¦‚æžœå‰ä¸€å¥æ‰§è¡Œ**æˆåŠŸ**åˆ™æ‰§è¡ŒåŽä¸€å¥**å¦åˆ™å…¶åŽä¸€å¥ä¸æ‰§è¡Œ**å¹¶ä¸”å…¶åŽä¸€å¥ç›´æŽ¥ç®—æ‰§è¡Œ**å¤±è´¥***
- `||` ï¼šè¡¨ç¤º *å¦‚æžœå‰ä¸€å¥æ‰§è¡Œ**å¤±è´¥**åˆ™æ‰§è¡ŒåŽä¸€å¥**å¦åˆ™å…¶åŽä¸€å¥ä¸æ‰§è¡Œ**å¹¶ä¸”å…¶åŽä¸€å¥ç›´æŽ¥ç®—æ‰§è¡Œ**æˆåŠŸ***
- `|` ï¼šè¡¨ç¤º ***è®©**å‰ä¸€å¥çš„å‘å‰ä¸€å¥çš„æ ‡å‡†è¾“å‡ºä¸­å†™å…¥çš„ä¿¡æ¯**è¢«**å†™å…¥åˆ°åŽä¸€å¥çš„æ ‡å‡†è¾“å…¥é‡Œ*

å…¶ä¸­ï¼Œå‰ä¸¤ä¸ª `;` `&` æˆ‘åˆå«å®ƒ *æ¡å°¾ç¬¦* ï¼Œè€Œ *ä¸€æ¡* å‘½ä»¤å°±æ˜¯ *åœ¨åŽé¢æ‰“å›žè½¦çš„è¯å°±ä¼šè®©å®ƒè¢«æ‰§è¡Œï¼ˆå³å¯¼è‡´åˆ›å»ºè¿›ç¨‹ï¼‰* å’Œé‚£ç§å‘½ä»¤ã€‚

åŽé¢ä¸‰ä¸ªï¼Œæˆ‘å«å®ƒä»¬ *å¥å°¾ç¬¦* ï¼Œå®ƒä»¬åŽé¢ç´§æŒ¨ç€çš„æ— æ•°ä¸ª**å›žè½¦æˆ–å…¶å®ƒç©ºç™½ç¬¦**éƒ½ç­‰ä»·äºŽ**å•ä¸ªç©ºæ ¼**ã€‚

è¿˜æœ‰æ‹¬å·å¯¹ï¼ˆè¿™åªæ˜¯ä¸€éƒ¨åˆ†ï¼‰ï¼š

- `{` `}`
- `(` `)`
- `'` `'`
- `"` `"`
- `do` `done`
- `case` `esac`

å®ƒä»¬å„æœ‰è‡ªå·±çš„åŠŸèƒ½ï¼Œä½†**å…±åŒçš„æ•ˆæžœ**å°±æ˜¯ï¼š

- å®ƒä»¬çš„å†…éƒ¨ï¼Œå¯ä»¥å†™å…¥**å¤š** ***æ¡*** å‘½ä»¤ï¼›å¯¹å¤–ï¼Œåˆ™æ•´ä½“åœ°ç­‰åŒäºŽ**ä¸€** ***å¥*** å‘½ä»¤ã€‚

å¦å¤–åˆ‡è®° SHell ä¸Šä¸€åˆ‡éƒ½æ˜¯å­—ç¬¦ä¸²ï¼ˆåŸºæœ¬ä¸Šå§ï¼‰ã€‚æ¯”å¦‚ï¼š

~~~ sh
echo foo\ \ foo
echo foo'  'foo
echo 'foo  foo'
'e'"c"\ho 'foo  foo'
~~~

è¿™é‡Œå››è¡Œæ˜¯å®Œå…¨ç­‰ä»·çš„ã€‚

åœ¨ SHell ä¸Šï¼Œ *è£¸è¯* æœ¬èº«å°±æ˜¯å­—é¢é‡ï¼Œæˆ–è€…ä¸æ˜¯å­—é¢é‡ï¼Œä½†å¦‚æžœä¸æ˜¯çš„è¯ä¹Ÿå¯ä»¥è½¬ä¹‰æˆå­—é¢é‡ï¼Œè€Œå¼•å·å’Œåæ–œçº¿éƒ½æ˜¯è½¬ä¹‰çš„æ‰‹æ®µï¼Œå…¶ä¸­åŒå¼•å·æ”¯æŒå­—ç¬¦ä¸²æ’å€¼å†™æ³•ä»…æ­¤è€Œå·²ã€‚

â€”â€”å½“ç„¶äº†ç”±äºŽç©ºç™½ç¬¦åœ¨ SHell ä¸Šä¸€èˆ¬æ˜¯ç‰¹æ®Šç¬¦å·ï¼Œæ‰€ä»¥å¦‚æžœæƒ³è®©ä¸€ä¸ªé€šè¿‡å¼•ç”¨ï¼ˆä¸ç®¡æ˜¯å˜é‡è¿˜æ˜¯å­è¿›ç¨‹æ ‡å‡†è¾“å‡ºè¿˜æ˜¯åˆ«çš„å•¥ï¼‰å¾—åˆ°çš„å­—ç¬¦ä¸²ä¿æŒåŽŸæ¨¡åŽŸæ ·çš„è¯ï¼Œå°±åªèƒ½ç”¨å¼•å·åŒ…è£¹æ‰è¡Œï¼ˆä¸‹åˆ—æƒ…å†µä¸ºå•¥ç”¨åŒå¼•å·æˆ–å•å¼•å·è‡ªå·±æµ‹è¯•ä¸Žæ€è€ƒï¼‰ï¼š

~~~ sh
str="${something:-default vals xxx}"
str="$(somecmd someargs)"
str="$(sh -c "echo '${something:-default vals xxx}'")"
str="$(sh -c "echo '$(somecmd someargs)'")"
~~~

ï¼ˆæç¤ºï¼šç¬¬ä¸‰è¡Œç¬¬å››è¡Œæ˜¯å¼•ç”¨äº†å½“å‰çŽ¯å¢ƒè€Œä¸æ˜¯å­è¿›ç¨‹çŽ¯å¢ƒçš„å˜é‡ã€‚ï¼‰

æˆ–è€…è¯•è¯•ä¸‹é¢å¾—åˆ°çš„æ¯ä¸ªå˜é‡ï¼Œå†è¯•è¯•å¦‚æžœåŽ»æŽ‰ä¸€äº›å¼•å·çš„è¯ä¼šæœ‰å•¥æ•ˆæžœã€‚ï¼ˆå°±æ˜¯è¯´ï¼š**é€šè¿‡æ‹¿èµ°å¿…è¦çš„ä¸œè¥¿ä¼šå¸®ä½ æ˜Žç™½å®ƒä¸ºä»€ä¹ˆå¿…è¦â€”â€”æ‰€ä»¥å°½ç®¡æ‹†å§ï¼**ï¼‰

~~~ sh
str0="${HAHAHAHA:-$(cat /etc/hosts)}"
str1="$str0"
str2="$(sh -c "echo '$str0'")"
str3="$(sh -c "echo '$(cat /etc/hosts)'")"
~~~

ï¼ˆå½“ç„¶ä½ å¦‚æžœæœ‰æ›´å¥½çš„ä¾‹å­åˆ™ç”¨å®ƒæ¥å°è¯•æ›´å¥½ðŸ™ƒï¼‰

ä½¿ç”¨æ—¶è®°å¾—è¦è¿™æ ·ï¼š

~~~ sh
echo "$str0"
echo "$str1"
echo "$str2"
echo "$str3"
~~~

ï¼ˆä¹Ÿå¯ä»¥è¯•è¯•è¿™é‡ŒåŽ»æŽ‰åŒå¼•å·ï¼‰

> æ€è€ƒé¢˜ï¼š  
> -------  
> å¦‚æžœä¸Šé¢è¢« `cat` çš„ä¸æ˜¯ `/etc/hosts` è€Œæ˜¯ `/etc/profile` ï¼Œå°±æ˜¯è¯´ï¼šå®ƒçš„å†…å®¹é‡Œæœ‰å•å¼•å·å­˜åœ¨ï¼Œ  
> é‚£ï¼Œé‚£å››ä¸ªå˜é‡çš„èµ‹å€¼åˆåˆ†åˆ«ä¼šæ˜¯ä»€ä¹ˆæ•ˆæžœå‘¢ï¼ŸðŸ¦¥  
> 


